[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid

[program:apache2]
command=/usr/sbin/apache2ctl -D FOREGROUND
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
autorestart=true
startretries=3

[program:queue-worker]
process_name=%(program_name)s_%(process_num)02d
command=bash -c 'echo "Waiting for database..." && until php /var/www/html/artisan db:show --quiet 2>/dev/null; do sleep 1; echo "Waiting for database connection..."; done && php /var/www/html/artisan queue:work --sleep=3 --tries=3 --timeout=60 --queue=default'
user=www-data
directory=/var/www/html
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
numprocs=1
redirect_stderr=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
stopwaitsecs=60

# Pass environment variables
environment=
    APP_ENV="${APP_ENV}",
    APP_DEBUG="${APP_DEBUG}",
    APP_KEY="${APP_KEY}",
    APP_URL="${APP_URL}",
    DB_CONNECTION="${DB_CONNECTION}",
    DB_HOST="${DB_HOST}",
    DB_PORT="${DB_PORT}",
    DB_DATABASE="${DB_DATABASE}",
    DB_USERNAME="${DB_USERNAME}",
    DB_PASSWORD="${DB_PASSWORD}"

[program:scheduler]
process_name=%(program_name)s_%(process_num)02d
command=/bin/bash -c "while [ true ]; do (php /var/www/html/artisan schedule:run --verbose --no-interaction &); sleep 60; done"
user=www-data
directory=/var/www/html
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
numprocs=1
stdout_logfile=/var/www/html/storage/logs/scheduler.log
stdout_logfile_maxbytes=0
stderr_logfile_maxbytes=0

# Use the same environment as the web process
environment=APP_ENV="${APP_ENV}",APP_DEBUG="${APP_DEBUG}",APP_KEY="${APP_KEY}",APP_URL="${APP_URL}",
    DB_CONNECTION="${DB_CONNECTION}",DB_HOST="${DB_HOST}",DB_PORT="${DB_PORT}",
    DB_DATABASE="${DB_DATABASE}",DB_USERNAME="${DB_USERNAME}",DB_PASSWORD="${DB_PASSWORD}"
redirect_stderr=true
stdout_logfile=/var/www/html/storage/logs/scheduler.log
